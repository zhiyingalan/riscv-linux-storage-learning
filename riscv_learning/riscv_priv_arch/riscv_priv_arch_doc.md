[TOC]

# RISC-V 特权模式核心章节学习

学习 RISC-V 特权模式的核心章节（基于你提供的《RISC-V Privileged Architecture》文档），聚焦你第一阶段学习目标（M/S/U 模式、异常/中断、MMU），关键章节如下（按优先级排序）：

### 一、核心必学章节（直接关联特权模式核心）

1. **第 1 章 Introduction（第 1.2 节）**
   1. 核心内容：特权级定义（M/S/U 三级）、权限边界、模式切换基础
   2. 关键价值：理解特权模式的核心作用（保护隔离），是后续内容的基础
2. **第 3 章 Machine-Level ISA（核心中的核心）**
   1. 重点小节：
      - 3.1.6：mstatus 寄存器（特权级栈、中断使能 MIE/SIE、模式切换关键字段）
      - 3.1.7：mtvec 寄存器（异常向量表，模式切换的入口配置）
      - 3.3.2：Trap-Return 指令（mret/sret，模式切换的核心指令）
   2. 关键价值：掌握 M 模式（最高特权）的配置与模式切换实操
3. **第 12 章 Supervisor-Level ISA**
   1. 重点小节：
      - 12.1.1：sstatus 寄存器（S 模式状态管理，与 mstatus 对应）
      - 12.1.2：stvec 寄存器（S 模式异常向量表）
      - 12.1.11：satp 寄存器（S 模式地址翻译开关，关联 MMU 与模式权限）
   2. 关键价值：理解 S 模式（OS 内核态）与 M 模式的交互，以及用户态/内核态切换逻辑

### 二、辅助理解章节（支撑特权模式实操）

1. **第 2 章 Control and Status Registers（CSRs）**
   1. 重点小节：2.1 CSR 地址映射（特权级访问控制）、2.2 CSR 清单（M/S 级关键寄存器）
   2. 关键价值：明确不同特权级可访问的寄存器，避免越权访问问题
2. **第 3 章 3.1.8-3.1.9 节**
   1. 核心内容：medeleg/mideleg 寄存器（异常/中断委托，模式间事件分发）、mip/mie 寄存器（中断管理）
   2. 关键价值：理解特权模式间的事件流转（如 S 模式处理 U 模式异常）

### 三、可暂略章节（第一阶段无需深入）

- 第 4-11 章：Smstateen、Smcsrind 等扩展（与基础特权模式无关）
- 第 22 章 Hypervisor 扩展（H 模式，超出你第一阶段学习范围）
- 第 23-25 章：CFI、指针掩码等高级特性（非特权模式核心）

### 总结

优先掌握「第 1.2 节 + 第 3 章核心小节 + 第 12 章核心小节」，即可覆盖特权模式的「定义-配置-切换-实操」全流程，完全匹配你第一阶段“理解 CPU 底层+支撑 Linux 内核启动”的目标。

提炼这些章节的「核心寄存器+关键指令+模式切换流程」速查表，方便集中记忆：

# RISC-V 特权模式核心速查表（Phase 1）

这份**RISC-V特权模式核心速查表**是为你第一阶段学习量身定制的，**直接对应你要精读的手册章节**。

你可以把它打印出来，贴在显示器旁边。调试 `OpenSBI` 或分析启动流程时，**90% 的问题都能靠这张表解决**。

# RISC-V 特权模式核心速查表（M/S/U）

**适用阶段**：Phase 1（RISC-V CPU底层筑基）

**核心目标**：理解「复位→M模式→S模式→Linux启动」的权限流转

## 一、 三大特权级速览（Chapter 1.2）

| 特权级             | 英文   | 运行内容       | 核心权限                   | 你的关注点                                  |
| :----------------- | :----- | :------------- | :------------------------- | :------------------------------------------ |
| **M (Machine)**    | 机器态 | OpenSBI 固件   | 最高权限，访问所有硬件/CSR | **重点**：初始化、异常入口、移交权限        |
| **S (Supervisor)** | 监管态 | Linux 内核     | 管理内存(MMU)、外设、中断  | **重点**：satp(页表)、内核运行、处理U态异常 |
| **U (User)**       | 用户态 | 应用程序 (App) | 受限，不能直接访问硬件     | **了解**：仅作对比，第一阶段暂不深入        |

## 二、 核心寄存器（Chapter 3 & Chapter 12）

**口诀**：**状态(status)定权限，向量(vec)定入口，异常(epc/cause)记现场，页表(satp)开地址。**

### 1. 状态控制（模式切换的开关）

| 寄存器      | 特权级 | 核心位段 (必须掌握)                                          | 作用                                    |
| :---------- | :----- | :----------------------------------------------------------- | :-------------------------------------- |
| **mstatus** | M      | **MIE** (全局中断使能)<br>**SIE** (S态中断使能)<br>**MPP** (异常返回后进入的模式) | **M态总控**。决定返回后是进S态还是M态。 |
| **sstatus** | S      | **SIE** (S态中断使能)<br>**SPP** (U态/ S态返回)              | **S态控制**。内核用来管理自身中断。     |

### 2. 异常入口（去哪儿处理？）

| 寄存器    | 特权级 | 作用                  | 典型值                      |
| :-------- | :----- | :-------------------- | :-------------------------- |
| **mtvec** | M      | **M态异常向量表基址** | 指向 OpenSBI 的异常处理入口 |
| **stvec** | S      | **S态异常向量表基址** | 指向 Linux 内核的 trap 入口 |

### 3. 异常现场（发生了什么？）

| 寄存器     | 特权级 | 作用                       | 调试价值                             |
| :--------- | :----- | :------------------------- | :----------------------------------- |
| **mepc**   | M      | 异常发生时的**程序计数器** | 记录崩溃前执行到哪条指令             |
| **mcause** | M      | 异常**原因码**             | 判断是中断(最高位1)还是异常(最高位0) |
| **sepc**   | S      | S态异常的程序计数器        | Linux 内核崩溃时查看                 |
| **scause** | S      | S态异常的原因码            | 同上                                 |

### 4. 地址翻译（MMU 的开关）

| 寄存器   | 特权级 | 核心作用           | 你的学习重点                                                 |
| :------- | :----- | :----------------- | :----------------------------------------------------------- |
| **satp** | S      | **页表基址寄存器** | **重中之重**。写入此寄存器 = **开启MMU**。<br>格式：`MODE(8) |

### 5. 中断委托（谁来处理？）

| 寄存器      | 作用     | 第一阶段策略                                   |
| :---------- | :------- | :--------------------------------------------- |
| **medeleg** | 异常委托 | 设为全1，把大部分异常**委托**给 S态(Linux)处理 |
| **mideleg** | 中断委托 | 设为全1，把大部分中断**委托**给 S态(Linux)处理 |

## 三、 关键指令（Chapter 2.1 & 3.3.2）

| 指令              | 特权级 | 功能            | 场景                                  |
| :---------------- | :----- | :-------------- | :------------------------------------ |
| **csrr rd, csr**  | 对应   | 读 CSR 到寄存器 | 读取 `mepc`、`mcause` 分析错误        |
| **csrw csr, rs1** | 对应   | 写寄存器到 CSR  | 设置 `mtvec`、`satp`、`mstatus`       |
| **ecall**         | U/S    | 发起环境调用    | 用户态/内核态主动陷入特权模式         |
| **mret**          | M      | **M态异常返回** | OpenSBI 干完活，**跳转到 Linux 内核** |
| **sret**          | S      | **S态异常返回** | Linux 内核处理完，返回应用程序        |

## 四、 完整模式切换流程（核心面试题）

### 场景：OpenSBI (M态) 启动 Linux (S态)

1. **初始化 M态**：设置 `mtvec` 指向 M态异常处理函数。
2. **配置委托**：设置 `medeleg`/`mideleg`，把权限下放给 S态。
3. **准备 S态环境**：
   1. 设置 `mstatus.MPP = S` (表示 mret 后进入 S模式)。
   2. 设置 `mstatus.MIE = 1` (开启全局中断)。
4. **设置内核入口**：将 Linux 内核的入口地址写入 `mepc`。
5. **关键一跳**：执行 **`mret`** 指令。
   1. CPU 从 `mepc` 取出地址（Linux入口）。
   2. 特权级切换为 **S态**。
   3. Linux 内核开始执行。

## 五、 调试命令（GDB 实操）

在第一阶段调试时，用这些命令查看上述状态：

```Plain
# 查看 M态 核心寄存器
info registers mstatus mtvec mepc mcause

# 查看 S态 核心寄存器 (进入Linux后使用)
info registers sstatus stvec sepc scause satp

# 查看 CSR 详细值 (例如查看 mtvec)
p/x $mtvec
```

### 使用建议

1. **先背表**：不用理解每一位，先把 **mstatus, mtvec, mepc, satp** 这四个寄存器的名字和作用背下来。
2. **对照代码**：看 `OpenSBI` 源码时，拿着这张表找对应的 `csrw` 指令。
3. **调试验证**：在 QEMU 里跑起来，用 GDB 查看寄存器值是否和表中描述一致。